---
# tasks file for server-sing-box
- name: Update apt repo and cache on all Debian/Ubuntu boxes
  apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
- name: Upgrade all packages on servers
  apt: upgrade=dist force_apt_get=yes
- name: Install jq
  ansible.builtin.package:
    name: jq
    state: present
- name: Fetch the latest (including pre-releases) release version number from GitHub API
  ansible.builtin.command: 'curl -s "https://api.github.com/repos/SagerNet/sing-box/releases" | jq -r ".[0].name"'
  register: singbox_core_ver 
- name: Fetch the latest (including pre-releases) release version number from GitHub API
  ansible.builtin.command: 'curl -s "https://api.github.com/repos/SagerNet/sing-box/releases" | jq -r ".[0].name"'
  register: singbox_core_ver 
- name: Creating singbox directory if it does not exist
  ansible.builtin.file:
    path: '{{ singbox_path }}'
    state: directory
    owner: root
    group: root
    mode: '0755'
- name: Extracting downloaded singbox
  ansible.builtin.unarchive:
    src: '{{ singbox_core_url }}'
    dest: '{{ singbox_path }}'
    remote_src: yes 
- name: Changing mode singbox file
  ansible.builtin.file:
    path: '{{ singbox_path }}/singbox'
    mode: '0755'
- name: Template for reality.json
  ansible.builtin.template:
    src: reality.json.jinja
    dest: '{{ singbox_path }}/reality.json'
    mode: '0644'
- name: Return key pair to registered var
  ansible.builtin.command: '{{ singbox_path }}/singbox generate reality-keypair'
  register: key_pair
- name: Return UUID to registered var
  ansible.builtin.command: '{{ singbox_path }}/singbox generate uuid'
  register: uuid   
- name: Return short id to registered var
  ansible.builtin.command: '{{ singbox_path }}/singbox generate rand --hex 8'
  register: short_id    
# - name: Return server_ipv4 to registered var
#   ansible.builtin.command: 'curl -s https://api.ipify.org'
#   register: server_ipv4   
- name: Template for singbox.service
  ansible.builtin.template:
    src: singbox.service.jinja
    dest: '/etc/systemd/system/singbox.service'
    mode: '0644'
- name: Enabling and starting singbox.service
  ansible.builtin.shell: systemctl daemon-reload && systemctl enable --now singbox
- name: Print the server details
  ansible.builtin.debug:
    msg:
    - "Server IP: {{ server_ip }}"
    - "Listen Port: {{ listen_port }}"
    - "Server Name: {{ server_name }}"
    - "Private Key: {{ private_key }}"
    - "Public Key: {{ public_key }}"
    - "Short ID: {{ short_id }}"
    - "UUID: {{ uuid }}"

